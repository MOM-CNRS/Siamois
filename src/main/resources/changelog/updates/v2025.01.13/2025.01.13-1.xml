<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <changeSet id="2025.01.13-1" author="Julien Linget">

        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="history_recording_unit"/>
                </not>
                <not>
                    <tableExists tableName="history_recording_unit_study"/>
                </not>
                <not>
                    <tableExists tableName="history_specimen_study"/>
                </not>
                <not>
                    <tableExists tableName="history_specimen"/>
                </not>
                <not>
                    <tableExists tableName="history_siamois_document"/>
                </not>
                <not>
                    <tableExists tableName="history_action_unit"/>
                </not>
                <not>
                    <tableExists tableName="history_spatial_unit"/>
                </not>
            </and>
        </preConditions>

        <sql>
            CREATE TABLE history_recording_unit
            (
                LIKE recording_unit INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_recording_unit
            DROP CONSTRAINT history_recording_unit_pkey;

            ALTER TABLE history_recording_unit
            DROP CONSTRAINT history_recording_unit_fk_ark_id_key;

            CREATE TABLE history_recording_unit_study
            (
                LIKE recording_unit_study INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_recording_unit_study
            DROP CONSTRAINT history_recording_unit_study_pkey;

            alter table history_recording_unit_study
                drop constraint history_recording_unit_study_fk_ark_id_key cascade;

            CREATE TABLE history_specimen_study
            (
                LIKE specimen_study INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_specimen_study
            DROP CONSTRAINT history_specimen_study_pkey;

            alter table history_specimen_study
                drop constraint history_specimen_study_fk_ark_id_key cascade;

            CREATE TABLE history_specimen
            (
                LIKE specimen INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_specimen
            DROP CONSTRAINT history_specimen_pkey;

            alter table history_specimen
                drop constraint history_specimen_fk_ark_id_key cascade;

            CREATE TABLE history_siamois_document
            (
                LIKE siamois_document INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_siamois_document
            DROP CONSTRAINT history_siamois_document_pkey;

            alter table history_siamois_document
                drop constraint history_siamois_document_fk_ark_id_key cascade;


            CREATE TABLE history_action_unit
            (
                LIKE action_unit INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_action_unit
            DROP CONSTRAINT history_action_unit_pkey;

            alter table history_action_unit
                drop constraint history_action_unit_fk_ark_id_key cascade;

            CREATE TABLE history_spatial_unit
            (
                LIKE spatial_unit INCLUDING ALL,
                creation_date timestamptz DEFAULT NOW()
            );

            ALTER TABLE history_spatial_unit
            DROP CONSTRAINT history_spatial_unit_pkey;

            alter table history_spatial_unit
                drop constraint history_spatial_unit_fk_ark_id_key cascade;

        </sql>

    </changeSet>

</databaseChangeLog>