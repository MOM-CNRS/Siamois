<!-- /resources/components/entityTable.xhtml -->
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:sharedInput="http://xmlns.jcp.org/jsf/composite/pages/shared/input"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:cellheader="http://java.sun.com/jsf/composite/pages/shared/cellheader"
                xmlns:cc="http://xmlns.jcp.org/jsf/composite">

    <cc:interface>

        <cc:attribute name="tableModel" required="true" type="fr.siamois.ui.table.EntityTableViewModel"/>
        <cc:attribute name="panelIndex" required="true" type="java.lang.Integer"/>
        <cc:attribute name="displayColumnToggler" required="false" default="false" type="java.lang.Boolean"/>
        <cc:attribute name="tableClass" required="false" default="siamois-unit-table" type="java.lang.String"/>

        <!-- Facettes de colonnes -->

        <cc:facet name="afterColumns"/>

        <!-- Facette toolbar droite, si besoin -->
        <cc:facet name="rightToolbar"/>
    </cc:interface>

    <cc:implementation>

        <p:outputPanel id="tableContainer">
            <p:dataTable paginator="true"
                         rendered="#{not cc.attrs.tableModel.treeMode}"
                         editable="true"
                         cellNavigation="true"
                         id="entityDatatable"
                         varStatus="status"
                         size="small"
                         paginatorPosition="bottom" var="item"
                         selectionPageOnly="false" selectionRowMode="none"
                         selection="#{cc.attrs.tableModel.lazyDataModel.selectedUnits}"
                         widgetVar="#{cc.clientId}_entityDatatable"
                         lazy="true"
                         globalFilter="#{cc.attrs.tableModel.lazyDataModel.globalFilter}"
                         allowUnsorting="true"
                         sortBy="#{cc.attrs.tableModel.lazyDataModel.sortBy}"
                         rows="#{cc.attrs.tableModel.lazyDataModel.pageSizeState}"
                         first="#{cc.attrs.tableModel.lazyDataModel.first}"
                         sortMode="multiple"
                         partialUpdate="false"
                         emptyMessage="#{langBean.msg('recordingUnitList.empty')}"
                         paginatorTemplate="Rows per page: {RowsPerPageDropdown} {RowReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                         rowsPerPageTemplate="5,10,15,20,25"
                         rowIndexVar="rowIndex"
                         tableStyle="width:auto"
                         value="#{cc.attrs.tableModel.lazyDataModel}"
                         class="#{cc.attrs.tableClass}">

                <f:facet name="{RowReport}">
                        <span class="ui-paginator-current">#{cc.attrs.tableModel.lazyDataModel.getFirstIndexOnPage()}-#{cc.attrs.tableModel.lazyDataModel.getLastIndexOnPage()}
                            of #{cc.attrs.tableModel.lazyDataModel.rowCount}</span>
                </f:facet>

                <!-- Toolbar générique, globalFilter, toggler, bulk etc. -->
                <f:facet name="header">
                    <p:toolbar id="tableToolbar">
                        <p:toolbarGroup>
                            <p:toolbarGroup align="left">
                                <div style="display:flex; flex-direction: column; gap:0.2em">

                                    <div>
                                        <p:toggleSwitch
                                                value="#{cc.attrs.tableModel.treeMode}"
                                                onIcon="bi bi-list-nested"
                                                offIcon="bi bi-list">

                                            <p:ajax
                                                    process="@this"
                                                    update=":#{cc.clientId}:tableContainer"/>
                                        </p:toggleSwitch>
                                        <!-- Global search -->
                                        <span class="filter-container ui-input-icon-left">
                                            <i class="bi bi-search"/>

                                                        <p:inputText id="globalFilter"
                                                                     value="#{cc.attrs.tableModel.lazyDataModel.globalFilter}"
                                                                     onkeyup="PF('#{cc.clientId}_entityDatatable').filter()"
                                                                     placeholder="#{langBean.msg('common.action.search')}">


                                                        </p:inputText>
                                            </span>

                                        <!-- Column toggler -->
                                        <p:commandButton
                                                rendered="#{cc.attrs.displayColumnToggler}"
                                                style="margin-left: 1em;" id="toggler" type="button"
                                                value="#{langBean.msg('table.columnvisibility')}"
                                                icon="pi pi-align-justify"/>
                                        <p:columnToggler
                                                rendered="#{cc.attrs.displayColumnToggler}"
                                                datasource=":#{cc.clientId}:entityDatatable"
                                                trigger=":#{cc.clientId}:entityDatatable:toggler">
                                            <p:ajax event="toggle" listener="#{cc.attrs.tableModel.onToggle}"/>
                                        </p:columnToggler>
                                    </div>
                                    <p:outputPanel id="bulkEditPanel"
                                                   rendered="#{cc.attrs.tableModel.lazyDataModel.selectedUnits.size() >0 and flowBean.isWriteMode}"
                                                   style="display:flex; flex-direction: row; gap:0.5em;">
                                        <span>Edition du type en lot (les autres colonnes viendront plus tard) :</span>
                                        <sharedInput:conceptAutocompleteFieldCode id="bulkTypeComponent"
                                                                                  panelStyleClass="recording-unit-autocomplete"
                                                                                  selectedConcept="#{cc.attrs.tableModel.lazyDataModel.bulkEditTypeValue}"
                                                                                  field="#{cc.attrs.tableModel.lazyDataModel.typeField}"
                                                                                  editConceptUrl="#{spatialUnitFieldBean.getUrlForFieldCode('SIARU.TYPE')}"/>
                                        <p:commandButton value="Enregistrer"
                                                         update=":#{cc.clientId}:entityDatatable"
                                                         action="#{cc.attrs.tableModel.lazyDataModel.saveFieldBulk()}"
                                        />
                                    </p:outputPanel>

                                </div>


                            </p:toolbarGroup>


                        </p:toolbarGroup>
                        <p:toolbarGroup align="right">
                            <cc:renderFacet name="rightToolbar"/>
                        </p:toolbarGroup>
                    </p:toolbar>
                </f:facet>

                <p:column selectionBox="true" style="width:16px;text-align:center"/>

                <!-- 2) Colonnes dynamiques, basées sur tableDefinition -->
                <p:columns value="#{cc.attrs.tableModel.columns}"
                           var="column"
                           varStatus="colStatus">

                    <!-- Header -->
                    <f:facet name="header">
                        #{langBean.msg(column.headerKey)}
                    </f:facet>

                    <!-- Contexte de formulaire pour cette ligne -->
                    <ui:param name="rowContext"
                              value="#{cc.attrs.tableModel.getRowContext(item)}"/>

                    <!-- ========================= -->
                    <!-- 1) FORM FIELD COLUMN PATH -->
                    <!-- ========================= -->
                    <ui:fragment rendered="#{column.type eq 'FORM_FIELD'}">

                        <ui:include src="/pages/shared/form/customFormFieldContentForTable.xhtml">
                            <ui:param name="bean" value="#{rowContext}"/>
                            <ui:param name="col" value="#{column}"/>
                            <ui:param name="prefix" value="table"/>
                            <ui:param name="statusIndex" value="#{status.index}"/>
                            <ui:param name="rowIndex" value="#{rowIndex}"/>
                            <ui:param name="colIndex" value="#{colStatus.index}"/>
                            <ui:param name="root" value="#{component.clientId}"/>
                            <ui:param name="panelIndex" value="0"/>

                            <ui:param name="answer"
                                      value="#{rowContext.getFieldAnswer(column.field)}"/>

                            <ui:param name="hasBeenModified"
                                      value="#{answer != null and answer.hasBeenModified}"/>

                            <ui:param name="hasAutoGenerationFunction" value="false"/>
                            <ui:param name="onGenerateValue" value="#{null}"/>
                            <ui:param name="onModified" value="#{null}"/>
                        </ui:include>

                    </ui:fragment>

                    <!-- ========================= -->
                    <!-- 2) COMMAND LINK COLUMN    -->
                    <!-- ========================= -->
                    <ui:fragment rendered="#{column.type eq 'COMMAND_LINK'}">

                        <p:commandLink
                                action="#{cc.attrs.tableModel.handleAction(column, item, cc.attrs.panelIndex)}"
                                onstart="#{column.onstartJs}"
                                oncomplete="#{column.oncompleteJs}"
                                process="#{column.processExpr}"
                                update="#{column.updateExpr}">

                            <h:outputText value="#{cc.attrs.tableModel.resolveText(column, item)}"/>
                        </p:commandLink>

                    </ui:fragment>

                    <!-- ========================= -->
                    <!-- 3) RELATION COLUMN        -->
                    <!-- ========================= -->
                    <ui:fragment rendered="#{column.type eq 'RELATION'}">

                        <!-- Header with icon -->
                        <f:facet name="header">
                            <cellheader:withIcon
                                    icon="#{column.headerIcon}"
                                    text="#{langBean.msg(column.headerKey)}"/>
                        </f:facet>

                        <div style="display:flex; gap:1em; align-items:center;">

                            <!-- Count -->
                            <span>
                            #{cc.attrs.tableModel.resolveCount(column, item)}
                        </span>

                            <!-- VIEW button -->
                            <p:commandButton
                                    icon="#{column.viewIcon}"
                                    action="#{cc.attrs.tableModel.handleRelationAction(
                            column,
                            item,
                            cc.attrs.panelIndex,
                            'VIEW_RELATION')}"
                                    process="#{column.processExpr}"
                                    update="#{column.updateExpr}"
                                    onstart="#{column.onstartJs}"
                                    oncomplete="#{column.oncompleteJs}"/>

                            <!-- ADD button (optional) -->
                            <p:commandButton
                                    rendered="#{column.addEnabled
                            and cc.attrs.tableModel.isRendered(
                                column,
                                column.addRenderedKey,
                                item,
                                cc.attrs.panelIndex)}"
                                    icon="#{column.addIcon}"
                                    action="#{cc.attrs.tableModel.handleRelationAction(
                            column,
                            item,
                            cc.attrs.panelIndex,
                            'ADD_RELATION')}"
                                    oncomplete="PF('newUnitDiag').show()"
                                    update="newUnitForm"
                                    style="margin-right:.5rem"/>
                        </div>

                    </ui:fragment>


                </p:columns>


                <!-- ACTIONS COLUMN (always last, content depends on tableModel) -->
                <p:column exportable="false" toggleable="false">

                    <p:toolbar>
                        <p:toolbarGroup>

                            <ui:repeat value="#{cc.attrs.tableModel.rowActions}" var="action">

                                <p:commandButton
                                        rendered="#{cc.attrs.tableModel.isRendered(action, item)}"
                                        icon="#{cc.attrs.tableModel.resolveIcon(action, item)}"
                                        action="#{cc.attrs.tableModel.handleRowAction(action, item)}"
                                        process="#{empty action.processExpr ? '@this' : action.processExpr}"
                                        update="#{action.updateSelfTable
                                    ? (':'.concat(cc.clientId).concat(':entityDatatable'))
                                    : action.updateExpr}"
                                        styleClass="#{action.styleClass}"/>

                            </ui:repeat>

                        </p:toolbarGroup>
                    </p:toolbar>

                </p:column>


            </p:dataTable>

            <p:blockUI block="entityDatatable" trigger="entityDatatable"
                       widgetVar="#{cc.clientId}_buiEntityDatatable">
                <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
            </p:blockUI>

            <p:treeTable id="entityTreeTable"
                         rendered="#{cc.attrs.tableModel.treeMode}"
                         value="#{cc.attrs.tableModel.treeRoot}"
                         var="item"
                         widgetVar="#{cc.clientId}_entityTreeTable"

                         cellNavigation="true"
                        selectionMode="checkbox"
                         varStatus="status"
                         size="small"
                         paginatorPosition="bottom"
                         selectionRowMode="none"
                         propagateSelectionUp="false"
                         propagateSelectionDown="false"
                         lazy="true"
                         globalFilter="#{cc.attrs.tableModel.lazyDataModel.globalFilter}"
                         allowUnsorting="true"
                         sortBy="#{cc.attrs.tableModel.lazyDataModel.sortBy}"
                         rows="#{cc.attrs.tableModel.lazyDataModel.pageSizeState}"
                         first="#{cc.attrs.tableModel.lazyDataModel.first}"
                         sortMode="multiple"
                         partialUpdate="false"
                         emptyMessage="#{langBean.msg('recordingUnitList.empty')}"
                         paginatorTemplate="Rows per page: {RowsPerPageDropdown} {RowReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                         rowsPerPageTemplate="5,10,15,20,25"
                         rowIndexVar="rowIndex"
                         tableStyle="width:auto"

                         class="#{cc.attrs.tableClass}"

                         styleClass="#{cc.attrs.tableClass}">
                <f:facet name="{RowReport}">
                        <span class="ui-paginator-current">#{cc.attrs.tableModel.lazyDataModel.getFirstIndexOnPage()}-#{cc.attrs.tableModel.lazyDataModel.getLastIndexOnPage()}
                            of #{cc.attrs.tableModel.lazyDataModel.rowCount}</span>
                </f:facet>

                <!-- Toolbar générique, globalFilter, toggler, bulk etc. -->
                <f:facet name="header">
                    <p:toolbar id="tableToolbar">
                        <p:toolbarGroup>
                            <p:toolbarGroup align="left">
                                <div style="display:flex; flex-direction: column; gap:0.2em">

                                    <div>
                                        <p:toggleSwitch
                                                value="#{cc.attrs.tableModel.treeMode}"
                                                onIcon="bi bi-list-nested"
                                                offIcon="bi bi-list">

                                            <p:ajax
                                                    process="@this"
                                                    update=":#{cc.clientId}:tableContainer"/>
                                        </p:toggleSwitch>
                                        <!-- Global search -->
                                        <span class="filter-container ui-input-icon-left">
                                            <i class="bi bi-search"/>

                                                        <p:inputText id="globalFilter"
                                                                     value="#{cc.attrs.tableModel.lazyDataModel.globalFilter}"
                                                                     onkeyup="PF('#{cc.clientId}_entityTreeTable').filter()"
                                                                     placeholder="#{langBean.msg('common.action.search')}">


                                                        </p:inputText>
                                            </span>

                                        <!-- Column toggler -->
                                        <p:commandButton
                                                rendered="#{cc.attrs.displayColumnToggler}"
                                                style="margin-left: 1em;" id="toggler" type="button"
                                                value="#{langBean.msg('table.columnvisibility')}"
                                                icon="pi pi-align-justify"/>
                                        <p:columnToggler
                                                rendered="#{cc.attrs.displayColumnToggler}"
                                                datasource=":#{cc.clientId}:entityTreeTable"
                                                trigger=":#{cc.clientId}:entityTreeTable:toggler">
                                            <p:ajax event="toggle" listener="#{cc.attrs.tableModel.onToggle}"/>
                                        </p:columnToggler>
                                    </div>


                                </div>


                            </p:toolbarGroup>


                        </p:toolbarGroup>
                        <p:toolbarGroup align="right">
                            <cc:renderFacet name="rightToolbar"/>
                        </p:toolbarGroup>
                    </p:toolbar>
                </f:facet>

                <p:column selectionBox="true" style="width:16px;text-align:center"/>

                <!-- 2) Colonnes dynamiques, basées sur tableDefinition -->
                <p:columns value="#{cc.attrs.tableModel.columns}"
                           var="column"
                           varStatus="colStatus">

                    <!-- Header -->
                    <f:facet name="header">
                        #{langBean.msg(column.headerKey)}
                    </f:facet>

                    <!-- Contexte de formulaire pour cette ligne -->
                    <ui:param name="rowContext"
                              value="#{cc.attrs.tableModel.getRowContext(item)}"/>

                    <!-- ========================= -->
                    <!-- 1) FORM FIELD COLUMN PATH -->
                    <!-- ========================= -->
                    <ui:fragment rendered="#{column.type eq 'FORM_FIELD'}">

                        <ui:include src="/pages/shared/form/customFormFieldContentForTable.xhtml">
                            <ui:param name="bean" value="#{rowContext}"/>
                            <ui:param name="col" value="#{column}"/>
                            <ui:param name="prefix" value="table"/>
                            <ui:param name="statusIndex" value="#{status.index}"/>
                            <ui:param name="rowIndex" value="#{rowIndex}"/>
                            <ui:param name="colIndex" value="#{colStatus.index}"/>
                            <ui:param name="root" value="#{component.clientId}"/>
                            <ui:param name="panelIndex" value="0"/>

                            <ui:param name="answer"
                                      value="#{rowContext.getFieldAnswer(column.field)}"/>

                            <ui:param name="hasBeenModified"
                                      value="#{answer != null and answer.hasBeenModified}"/>

                            <ui:param name="hasAutoGenerationFunction" value="false"/>
                            <ui:param name="onGenerateValue" value="#{null}"/>
                            <ui:param name="onModified" value="#{null}"/>
                        </ui:include>

                    </ui:fragment>

                    <!-- ========================= -->
                    <!-- 2) COMMAND LINK COLUMN    -->
                    <!-- ========================= -->
                    <ui:fragment rendered="#{column.type eq 'COMMAND_LINK'}">

                        <p:commandLink
                                action="#{cc.attrs.tableModel.handleAction(column, item, cc.attrs.panelIndex)}"
                                onstart="#{column.onstartJs}"
                                oncomplete="#{column.oncompleteJs}"
                                process="#{column.processExpr}"
                                update="#{column.updateExpr}">

                            <h:outputText value="#{cc.attrs.tableModel.resolveText(column, item)}"/>
                        </p:commandLink>

                    </ui:fragment>

                    <!-- ========================= -->
                    <!-- 3) RELATION COLUMN        -->
                    <!-- ========================= -->
                    <ui:fragment rendered="#{column.type eq 'RELATION'}">

                        <!-- Header with icon -->
                        <f:facet name="header">
                            <cellheader:withIcon
                                    icon="#{column.headerIcon}"
                                    text="#{langBean.msg(column.headerKey)}"/>
                        </f:facet>

                        <div style="display:flex; gap:1em; align-items:center;">

                            <!-- Count -->
                            <span>
                            #{cc.attrs.tableModel.resolveCount(column, item)}
                        </span>

                            <!-- VIEW button -->
                            <p:commandButton
                                    icon="#{column.viewIcon}"
                                    action="#{cc.attrs.tableModel.handleRelationAction(
                            column,
                            item,
                            cc.attrs.panelIndex,
                            'VIEW_RELATION')}"
                                    process="#{column.processExpr}"
                                    update="#{column.updateExpr}"
                                    onstart="#{column.onstartJs}"
                                    oncomplete="#{column.oncompleteJs}"/>

                            <!-- ADD button (optional) -->
                            <p:commandButton
                                    rendered="#{column.addEnabled
                            and cc.attrs.tableModel.isRendered(
                                column,
                                column.addRenderedKey,
                                item,
                                cc.attrs.panelIndex)}"
                                    icon="#{column.addIcon}"
                                    action="#{cc.attrs.tableModel.handleRelationAction(
                            column,
                            item,
                            cc.attrs.panelIndex,
                            'ADD_RELATION')}"
                                    oncomplete="PF('newUnitDiag').show()"
                                    update="newUnitForm"
                                    style="margin-right:.5rem"/>
                        </div>

                    </ui:fragment>


                </p:columns>


                <!-- ACTIONS COLUMN (always last, content depends on tableModel) -->
                <p:column exportable="false" toggleable="false">

                    <p:toolbar>
                        <p:toolbarGroup>

                            <ui:repeat value="#{cc.attrs.tableModel.rowActions}" var="action">

                                <p:commandButton
                                        rendered="#{cc.attrs.tableModel.isRendered(action, item)}"
                                        icon="#{cc.attrs.tableModel.resolveIcon(action, item)}"
                                        action="#{cc.attrs.tableModel.handleRowAction(action, item)}"
                                        process="#{empty action.processExpr ? '@this' : action.processExpr}"
                                        update="#{action.updateSelfTable
                                    ? (':'.concat(cc.clientId).concat(':entityDatatable'))
                                    : action.updateExpr}"
                                        styleClass="#{action.styleClass}"/>

                            </ui:repeat>

                        </p:toolbarGroup>
                    </p:toolbar>

                </p:column>
            </p:treeTable>


        </p:outputPanel>



    </cc:implementation>
</ui:composition>
