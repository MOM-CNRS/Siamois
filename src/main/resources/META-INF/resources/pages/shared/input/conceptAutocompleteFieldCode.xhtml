<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:cc="http://java.sun.com/jsf/composite"
        xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
>

    <cc:interface>

        <cc:attribute name="itemSelectListener" required="false" method-signature="void &lt;java.lang.String&gt;(java.lang.Object)" />
        <cc:attribute name="selectedConcept" type="fr.siamois.infrastructure.database.repositories.vocabulary.dto.ConceptAutocompleteDTO" required="true"/>
        <cc:attribute name="editConceptUrl" required="true"/>
        <cc:attribute name="disabled" required="false" default="false"/>
        <cc:attribute name="ajaxUpdateTargets" required="false" default="@form"/>
        <cc:attribute name="panelId" type="String" required="false"/>
        <cc:attribute name="ajaxProcessTargets" required="false" default="@this"/>
        <cc:attribute name="panelStyleClass" required="false" default="sia-autocomplete-panel"/>
        <cc:attribute name="field" required="true"/>
        <cc:attribute name="inputStyleClass" required="false" default=""/>
        <cc:attribute name="label" type="String" required="false"/>
        <cc:attribute name="required" type="java.lang.Boolean" required="false" default="false"/>


    </cc:interface>

    <cc:implementation>
        <!--@elvariable id="autocompleteDto" type="fr.siamois.infrastructure.database.repositories.vocabulary.dto.ConceptAutocompleteDTO"-->
        <p:autoComplete value="#{cc.attrs.selectedConcept}"
                        id="conceptAutocomplete"
                        completeMethod="#{spatialUnitFieldBean.completeWithFieldCode}"
                        var="autocompleteDto"
                        panelStyleClass="#{cc.attrs.panelStyleClass}"
                        itemValue="#{autocompleteDto}"
                        itemLabel="#{autocompleteDto.conceptLabelToDisplay.label}"
                        disabled="#{cc.attrs.disabled}"
                        inputStyleClass="#{cc.attrs.inputStyleClass}"
                        required="#{cc.attrs.required}"
                        onmousedown="event.stopPropagation();"
                        onclick="event.stopPropagation();"
                        converter="#{conceptAutocompleteDTOConverter}"
                        forceSelection="true"
                        scrollHeight="300"
                        onchange="this.input[0].classList.add('sia-modified-field')"
                        dropdown="true"
                        placeholder="#{langBean.msg('common.action.chooseConcept')}"
                        showEmptyMessage="false"
                        maxResults="#{fieldConfigurationService.resultLimit()}"
        >
            <f:attribute name="fieldCode" value="#{cc.attrs.field.fieldCode}" />
            <f:attribute name="field" value="#{cc.attrs.field}" />
            <f:attribute name="selected" value="#{cc.attrs.selectedConcept}"/>



            <f:facet name="itemtip">
                <h:panelGrid columns="1" cellpadding="5" styleClass="#{cc.attrs.panelStyleClass}"
                style="background: var(--main-color); min-width: 20em;">

                    <small>#{autocompleteDto.originalPrefLabel}</small><br/>
                    <small><i>#{autocompleteDto.altlabelsAsString()}</i></small><br/>
                    <small>#{autocompleteDto.definition}</small><br/>
                    <p:commandLink
                            onclick="window.open('#{autocompleteDto.vocabulary().baseUri}/?idc=#{autocompleteDto.concept().externalId}&amp;idt=#{autocompleteDto.vocabulary().externalVocabularyId}', '_blank'); return false;"
                    >
                        <small><i>#{langBean.msg("common.action.seeMore")}</i></small>
                    </p:commandLink>

                </h:panelGrid>
            </f:facet>

            <!-- If defined, we need to update on select to synchronise secondary type choices -->
            <p:ajax
                    event="itemSelect"
                    listener="#{cc.attrs.itemSelectListener}"
                    disabled="#{empty cc.attrs.itemSelectListener}"
                    update="#{cc.attrs.ajaxUpdateTargets}"
                    immediate="true"
                    onstart="$(PrimeFaces.escapeClientId('#{cc.clientId}:input')).removeClass('sia-modified-field'); showSpinner('#{cc.attrs.panelId}')"
                    oncomplete="hideSpinner('#{cc.attrs.panelId}')"
                    onerror="handleAutoSaveError(xhr, status, '#{cc.attrs.panelId}'); $(PrimeFaces.escapeClientId('#{cc.clientId}:input')).addClass('sia-modified-field');"
                    process="#{cc.attrs.ajaxProcessTargets}"/>

            <p:column>
                <p:commandLink
                                 onclick="event.stopPropagation(); window.open('#{autocompleteDto.vocabulary().baseUri}/?idc=#{autocompleteDto.concept().externalId}&amp;idt=#{autocompleteDto.vocabulary().externalVocabularyId}', '_blank'); return false;"
                >
                    <i class="bi bi-box-arrow-up-right"></i>
                </p:commandLink>
            </p:column>
            <p:column>

                <h:panelGroup id="conceptItem" layout="block" style="display:flex; flex-direction: column">
                    <h:outputText style="vertical-align: middle" value="#{autocompleteDto.conceptLabelToDisplay.label}"/>
                    <h:panelGroup rendered="#{autocompleteDto.conceptLabelToDisplay.altLabel}">
                        <small>#{langBean.msg('concept.common.preflabel')} : #{autocompleteDto.originalPrefLabel}</small>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not empty autocompleteDto.hierarchyPrefLabels}">
                        <small>#{langBean.msg('concept.common.parents')} : #{autocompleteDto.hierarchyPrefLabels}</small>
                    </h:panelGroup>
                </h:panelGroup>

            </p:column>

            <f:facet name="footer">
                <div class="ui-fluid" style="padding:0.5rem 1rem 1rem 1rem">
                    <h:outputLink value="#{cc.attrs.editConceptUrl}" target="_blank"
                                  disabled="#{empty cc.attrs.editConceptUrl}"
                                  styleClass="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only">
                        <span class="ui-button-text">#{langBean.msg('common.action.editConcept')}</span>
                    </h:outputLink>
                </div>
            </f:facet>
        </p:autoComplete>

    </cc:implementation>

</ui:composition>