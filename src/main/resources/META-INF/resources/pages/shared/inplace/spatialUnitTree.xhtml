<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:cc="http://java.sun.com/jsf/composite"
        xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
>

    <cc:interface>
        <cc:attribute name="answer"
                      type="fr.siamois.domain.models.form.customfieldanswer.CustomFieldAnswerSelectMultipleSpatialUnitTree"
                      required="true"/>
        <cc:attribute name="formCtx" type="fr.siamois.ui.form.EntityFormContext"
                      required="true"/>
        <cc:attribute name="hasBeenModified" type="Boolean" required="false" default="false"/>
        <cc:attribute name="field"
                      type="fr.siamois.domain.models.form.customfield.CustomFieldSelectMultipleSpatialUnitTree"
                      required="true"/>
        <cc:attribute name="mode" type="String" required="false" default="READ"/>
        <cc:attribute name="updateTargetsOnBlur" type="String" required="false" default="@this"/>
        <cc:attribute name="onModified"
                      method-signature="void setFieldAnswerHasBeenModified(javax.faces.event.AjaxBehaviorEvent)"
                      required="false"/>
    </cc:interface>

    <cc:implementation>
        <p:inplace mode="#{cc.attrs.mode}" toggleable="false">
            <f:facet name="output">
                <!-- Affichage de la liste normalisé des USp séléctionnées -->
                <h:panelGroup
                        rendered="#{not empty cc.attrs.formCtx.getNormalizedSpatialUnits(cc.attrs.answer)}">
                    <ui:repeat value="#{cc.attrs.formCtx.getNormalizedSpatialUnits(cc.attrs.answer)}" var="su">
                            <span>
                                <p:chip label="#{su.name}" styleClass="mr-2 mb-2" removable="false">
                                </p:chip>
                            </span>
                    </ui:repeat>
                </h:panelGroup>
                <h:panelGroup rendered="#{empty cc.attrs.formCtx.getNormalizedSpatialUnits(cc.attrs.answer)}">
                    <em>Aucune USp sélectionnée.</em>
                </h:panelGroup>
            </f:facet>
            <f:facet name="input">
                <!-- Affichage de la liste normalisé des USp séléctionnées -->
                <p:outputPanel id="selectedSpatialUnitPanel" style="margin-top:1rem">
                    <h:panelGroup
                            rendered="#{not empty cc.attrs.formCtx.getNormalizedSpatialUnits(cc.attrs.answer)}">
                        <ui:repeat value="#{cc.attrs.formCtx.getNormalizedSpatialUnits(cc.attrs.answer)}" var="su">
                            <span>
                                <p:chip label="#{su.name}" styleClass="mr-2 mb-2" removable="true">
                                    <p:ajax event="close"
                                            listener="#{cc.attrs.formCtx.removeSpatialUnit(cc.attrs.answer,su)}"
                                            update="#{cc.attrs.updateTargetsOnBlur}"/>
                                </p:chip>
                            </span>
                        </ui:repeat>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{empty cc.attrs.formCtx.getNormalizedSpatialUnits(cc.attrs.answer)}">
                        <em>Aucune USp sélectionnée.</em>
                    </h:panelGroup>
                </p:outputPanel>
                <!-- Séléction des USp dans un treenode -->
                <p:panel header="Table de sélection de l'emprise spatiale" toggleable="true" collapsed="true">
                    <p:treeTable value="#{cc.attrs.formCtx.getRoot(cc.attrs.answer)}"
                                 widgetVar="spatialUnitTreeTable"
                                 rows="5"
                                 id="selectSpatialTree"
                                 propagateSelectionUp="false"
                                 paginatorPosition="bottom"
                                 size="small"
                                 scrollable="true"
                                 scrollHeight="400px"
                                 paginator="true"
                                 var="su"
                                 styleClass="#{cc.attrs.answer.hasBeenModified ? 'track-change sia-modified-field': 'track-change'}"
                    >
                        <p:column headerText="Nom" filterBy="#{su.name}"
                                  filterMatchMode="contains">

                            <p:outputLabel value="#{su.getName()}" style="margin-right:1em"/>
                            <p:commandButton value="Ajouter"
                                             rendered="#{!cc.attrs.formCtx.treeStates.get(cc.attrs.answer).selection.contains(su)}"
                                             actionListener="#{cc.attrs.formCtx.addSUToSelection(cc.attrs.answer,su)}"
                                             process="@this"
                                             update="#{cc.attrs.updateTargetsOnBlur} #{cc.clientId}:selectedSpatialUnitPanel #{cc.clientId}:selectSpatialTree"
                                             immediate="true"/>

                        </p:column>

                        <f:facet name="emptyMessage">
                            <p:commandLink update="flow" action="#{flowBean.addSpatialUnitListPanel()}"
                                           onstart="PF('newUnitDiag').hide();PF('buiContent').show();"
                                           process="@this"
                                           oncomplete="PF('buiContent').hide()"
                                           value="Aucun lieu existant. Commencer par créer des lieux"/>
                        </f:facet>

                    </p:treeTable>
                </p:panel>
            </f:facet>
        </p:inplace>

    </cc:implementation>

</ui:composition>