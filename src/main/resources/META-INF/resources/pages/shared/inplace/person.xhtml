<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:cc="http://java.sun.com/jsf/composite"
        xmlns:cellbody="http://java.sun.com/jsf/composite/pages/shared/cellbody"
        xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core"
>

    <cc:interface>
        <cc:attribute name="answer" type="fr.siamois.ui.viewmodel.fieldanswer.CustomFieldAnswerSelectPersonViewModel" required="true"/>
        <cc:attribute name="hasBeenModified" type="Boolean" required="false" default="false"/>
        <cc:attribute name="field" type="fr.siamois.domain.models.form.customfield.CustomFieldSelectPerson"
                      required="true"/>
        <cc:attribute name="label" type="String" required="false"/>
        <cc:attribute name="required" type="java.lang.Boolean" required="true"/>
        <cc:attribute name="mode" type="String" required="false" default="READ"/>
        <cc:attribute name="updateTargetsOnBlur" type="String" required="false" default="@this"/>
        <cc:attribute name="multiple" type="Boolean" required="false" default="false"/>
        <cc:attribute name="panelStyleClass" type="String" required="false" default=""/>
        <cc:attribute name="onModified"
                      method-signature="void setFieldAnswerHasBeenModified(javax.faces.event.AjaxBehaviorEvent)"
                      required="false"/>
        <cc:attribute name="panelId" type="String" required="false"/>
    </cc:interface>

    <cc:implementation>
        <p:inplace id="inplace"  mode="#{cc.attrs.mode}" toggleable="false">
            <f:facet name="output">
                <!-- Single value -->
                <p:outputLabel rendered="#{(not cc.attrs.multiple) and (not empty cc.attrs.answer.value)}"
                               value="#{cc.attrs.answer.value.displayName()}"/>

                <!-- Multiple values -->
                <ui:fragment rendered="#{cc.attrs.multiple}">
                    <cellbody:cellBodyMultiplePersons persons="#{cc.attrs.answer.value}"/>
                </ui:fragment>
            </f:facet>
            <f:facet name="input">
                <p:autoComplete id="auto-complete-author"
                                panelStyleClass="#{panelStyleClass}"
                                inputStyle="width: 100%"
                                multiple="#{cc.attrs.multiple}"
                                inputStyleClass="#{cc.attrs.answer.hasBeenModified ? 'track-change sia-modified-field': 'track-change'}"
                                value="#{cc.attrs.answer.value}"
                                completeMethod="#{sessionSettingsBean.completePerson}"
                                forceSelection="true"
                                label="#{cc.attrs.label}"
                                required="#{cc.attrs.required}"
                                onchange="this.input[0].classList.add('sia-modified-field')"
                                scrollHeight="300"

                                var="person" itemLabel="#{person.displayName()}"
                                itemValue="#{person}"
                                converter="#{personConverter}"
                                dropdown="false">
                    <p:ajax update="#{cc.attrs.updateTargetsOnBlur}"
                            process="@this"
                            onstart="$(PrimeFaces.escapeClientId('#{cc.clientId}:input')).removeClass('sia-modified-field'); showSpinner('#{cc.attrs.panelId}')"
                            oncomplete="hideSpinner('#{cc.attrs.panelId}')"
                            onerror="handleAutoSaveError(xhr, status, '#{cc.attrs.panelId}'); $(PrimeFaces.escapeClientId('#{cc.clientId}:input')).addClass('sia-modified-field');"
                            listener="#{cc.attrs.onModified}"/>
                </p:autoComplete>
            </f:facet>
        </p:inplace>

    </cc:implementation>

</ui:composition>