<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:cc="http://java.sun.com/jsf/composite"
        xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
>

    <cc:interface>
        <cc:attribute name="answer" type="fr.siamois.domain.models.form.customfieldanswer.CustomFieldAnswerStratigraphy"
                      required="true"/>
        <cc:attribute name="hasBeenModified" type="Boolean" required="false" default="false"/>
        <cc:attribute name="field" type="fr.siamois.domain.models.form.customfield.CustomFieldStratigraphy"
                      required="true"/>
        <cc:attribute name="mode" type="String" required="false" default="READ"/>
        <cc:attribute name="updateTargetsOnBlur" type="String" required="false" default="@this"/>
        <cc:attribute
                name="recordingUnitOptions"
                type="java.util.List"
                required="true"/>
        <cc:attribute
                name="onAddStratigraphicRelationship"
                method-signature="void f(fr.siamois.domain.models.form.customfieldanswer.CustomFieldAnswerStratigraphy)"
                required="true"/>
    </cc:interface>

    <cc:implementation>
        <p:inplace mode="#{cc.attrs.mode}" toggleable="false">
            <f:facet name="output">
                <!-- just showing the diagram -->
            </f:facet>
            <f:facet name="input">
                <p:outputPanel id="newStratiRelForm">
                    <p:card styleClass="add-strati-rel"
                            style=" border: 1px dashed oklch(0.74 0 0);border-radius: 1em;background: #ffffff;">

                        <p:autoComplete id="relationshipVocab" value="#{answer.conceptToAdd}"
                                        style="width: 20em"
                                        completeMethod="#{spatialUnitFieldBean.completeWithFieldCode}"
                                        showEmptyMessage="false"
                                        maxResults="#{fieldConfigurationService.resultLimit()}"
                                        placeholder="#{langBean.msg('common.action.chooseConcept')}"
                                        dropdown="true"
                                        itemValue="#{autocompleteDto}"
                                        itemLabel="#{autocompleteDto.conceptLabelToDisplay.label}"
                                        var="autocompleteDto"
                                        forceSelection="true"
                                        scrollHeight="300"
                                        onclick="event.stopPropagation();"
                                        groupBy="#{spatialUnitFieldBean.getRootGroup(autocompleteDto)}"
                                        converter="#{conceptAutocompleteDTOConverter}"
                                        escape="false">
                            <f:attribute name="fieldCode" value="SIARU.STRATI"/>
                            <f:attribute name="sortByParent" value="true"/>
                        </p:autoComplete>
                        <p:message for="relationshipVocab"/>

                        <p:selectOneMenu id="selectRU"
                                         style="width: 10em"
                                         filter="true"
                                         panelStyleClass="recording-unit"
                                         value="#{cc.attrs.answer.targetToAdd}"
                                         var="ru"
                                         label="ru.fullIdentifier"
                                         converter="#{recordingUnitConverter}">
                            <f:selectItems
                                    var="unit"
                                    itemValue="#{unit}"
                                    itemLabel="#{unit.fullIdentifier}"
                                    value="#{cc.attrs.recordingUnitOptions}"/>

                            <p:column>
                                #{ru.fullIdentifier}
                            </p:column>

                        </p:selectOneMenu>
                        <p:message for="selectRU"/>

                        <p:selectBooleanCheckbox style="width: 10em" itemLabel="Incertain"
                                                 value="#{cc.attrs.answer.isUncertainToAdd}"/>

                        <p:commandButton
                                style="width: 10em"
                                icon="bi bi-plus"
                                value="Ajouter"
                                action="#{cc.attrs.onAddStratigraphicRelationship}"
                                update="newStratiRelForm, stratigraphyGraphContainer"
                                process="newStratiRelForm"
                        />
                    </p:card>

                    <p:outputPanel layout="block" id="stratigraphyGraphContainer" style="border: 2px solid var(--light-color-200);
margin-top: 1em;
  border-radius: 2em;display:flex;">

                        <svg style="flex:3;" id="#{cc.clientId}:stratigraphyGraph" width="800" height="500"></svg>

                    </p:outputPanel>

                    <h:outputScript>
                        const unit2Id = "#{cc.attrs.answer.sourceToAdd.fullIdentifier}";
                        const relationships = #{cc.attrs.answer.relationshipsAsJson};

                        drawStratigraphyDiagram(
                        "#{cc.clientId}:stratigraphyGraph",
                        unit2Id,
                        relationships
                        );
                    </h:outputScript>


                </p:outputPanel>


            </f:facet>
        </p:inplace>

    </cc:implementation>

</ui:composition>