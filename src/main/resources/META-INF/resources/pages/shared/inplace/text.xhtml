<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:cc="http://java.sun.com/jsf/composite"
        xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
>

    <cc:interface>
        <cc:attribute name="answer" type="fr.siamois.domain.models.form.customfieldanswer.CustomFieldAnswerText"
                      required="true"/>
        <cc:attribute name="hasBeenModified" type="Boolean" required="false" default="false"/>
        <cc:attribute name="field" type="fr.siamois.domain.models.form.customfield.CustomFieldText"
                      required="true"/>
        <cc:attribute name="mode" type="String" required="false" default="READ"/>
        <cc:attribute name="label" type="String" required="false"/>
        <cc:attribute name="panelId" type="String" required="false"/>
        <cc:attribute name="required" type="java.lang.Boolean" required="true"/>
        <cc:attribute name="updateTargetsOnBlur" type="String" required="false" default="@this"/>
        <!-- Callback appelé quand le champ est modifié -->
        <cc:attribute name="onModified"
                      method-signature="void setFieldAnswerHasBeenModified(javax.faces.event.AjaxBehaviorEvent)"
                      required="false"/>
        <cc:attribute name="onGenerateValue"
                      method-signature="void f(javax.faces.event.ActionEvent)"
                      required="false"/>
        <cc:attribute name="hasAutoGenerationFunction" type="java.lang.Boolean" required="false" default="false"/>
    </cc:interface>

    <cc:implementation>
        <p:inplace mode="#{cc.attrs.mode}" toggleable="false">
            <f:facet name="output">
                <h:panelGroup rendered="#{cc.attrs.field.isTextArea}">
                    <p:inputTextarea value="#{cc.attrs.answer.value}"
                                     style="width: 100%"
                                     disabled="true"
                                     label="#{cc.attrs.label}"
                    >
                    </p:inputTextarea>
                </h:panelGroup>
                <h:panelGroup rendered="#{not cc.attrs.field.isTextArea}">
                    <p:inputText value="#{cc.attrs.answer.value}"
                                 disabled="true"
                                 label="#{cc.attrs.label}"
                    >
                    </p:inputText>
                </h:panelGroup>
            </f:facet>
            <f:facet name="input">

                <h:panelGroup id="inputGroup" rendered="true">
                    <h:panelGroup rendered="#{cc.attrs.field.isTextArea}">
                        <p:inputTextarea value="#{cc.attrs.answer.value}"
                                         style="width: 100%"
                                         styleClass="#{cc.attrs.answer.hasBeenModified ? 'track-change sia-modified-field': 'track-change'}"
                                         label="#{cc.attrs.label}"
                                         onkeyup="this.classList.add('sia-modified-field')"
                                         required="#{cc.attrs.required}"
                        >
                            <f:attribute name="field" value="#{cc.attrs.field}" />
                            <p:ajax event="keyup" delay="1000" update="#{cc.attrs.updateTargetsOnBlur}"
                                    process="@this"

                                    listener="#{cc.attrs.onModified}"/>
                        </p:inputTextarea>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not cc.attrs.field.isTextArea}">
                        <p:commandButton
                                rendered="false"
                                icon="pi pi-refresh"
                                styleClass="rounded-button"
                                immediate="true"
                                process="@this"
                                actionListener="#{cc.attrs.onGenerateValue}"
                                update="#{cc.attrs.updateTargetsOnBlur}"
                        >
                            <f:attribute name="field" value="#{cc.attrs.field}" />
                            <f:attribute name="answer" value="#{cc.attrs.answer}" />
                        </p:commandButton>
                        <p:inputText value="#{cc.attrs.answer.value}"
                                     styleClass="#{cc.attrs.answer.hasBeenModified ? 'track-change sia-modified-field': 'track-change'}"
                                     label="#{cc.attrs.label}"
                                     id="input"
                                     required="#{cc.attrs.required}"
                        >
                            <f:attribute name="field" value="#{cc.attrs.field}" />
                            <p:ajax event="keyup" delay="2000" update="#{cc.attrs.updateTargetsOnBlur}"
                                    process="@this"
                                    onstart="$(PrimeFaces.escapeClientId('#{cc.clientId}:input')).removeClass('sia-modified-field'); showSpinner('#{cc.attrs.panelId}')"
                                    oncomplete="hideSpinner('#{cc.attrs.panelId}')"
                                    onerror="handleAjaxError(xhr, status, args, '#{cc.attrs.panelId}'); $(PrimeFaces.escapeClientId('#{cc.clientId}:input')).addClass('sia-modified-field');"
                                    listener="#{cc.attrs.onModified}"/>
                        </p:inputText>
                    </h:panelGroup>
                </h:panelGroup>

            </f:facet>
        </p:inplace>
    </cc:implementation>

</ui:composition>