<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:cc="http://xmlns.jcp.org/jsf/composite"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:form="http://java.sun.com/jsf/composite/pages/shared/form" xmlns:f="http://java.sun.com/jsf/core"
>
    <cc:interface>
        <!-- Attributes to pass the bean's list and optional additional parameters -->
        <cc:attribute name="lazyDataModel" required="true" type="org.primefaces.model.LazyDataModel"/>
        <cc:attribute name="panelModel" required="true" type="fr.siamois.ui.bean.panel.models.panel.AbstractPanel"/>
        <cc:attribute name="panelIndex" required="true" type="java.lang.Integer"/>
        <cc:attribute name="selectedCategories" required="true"/>
        <cc:attribute name="disableAddBtn" required="false" default="false" type="java.lang.Boolean"/>

    </cc:interface>
    <cc:implementation>

        <!--@elvariable id="panelModel" type="fr.siamois.ui.bean.panel.models.panel.SpatialUnitListPanel"-->
        <h:form id="spatialUnitListForm">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>


            <!-- datatable property partialUpdate=false because otherwise the paginator template is reset after sort or filter actions-->
            <p:dataTable paginator="true"
                         id="spatialUnitDataTable"
                         paginatorPosition="bottom" var="item"
                         widgetVar="#{cc.clientId}_spatialUnitListTable"
                         lazy="true"
                         sortMode="multiple"
                         partialUpdate="false"
                         emptyMessage="Aucune unité spatiale trouvée avec ces critères"
                         rows="10"
                         paginatorTemplate="Rows per page: {RowsPerPageDropdown} {RowReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                         rowsPerPageTemplate="5,10,15,20,25"
                         value="#{cc.attrs.lazyDataModel}" class="spatial-unit-datatable">

                <f:facet name="{RowReport}">
                        <span class="ui-paginator-current">#{cc.attrs.lazyDataModel.getFirstIndexOnPage()}-#{cc.attrs.lazyDataModel.getLastIndexOnPage()}
                            of #{cc.attrs.lazyDataModel.rowCount}</span>
                </f:facet>

                <f:facet name="header">
                    <p:toolbar>
                        <p:toolbarGroup>
                            <p:toolbarGroup align="left">

                                <!-- Global search -->
                                <span class="filter-container ui-input-icon-left">
                                <i class="bi bi-search"/>
                                            <p:inputText id="globalFilter"
                                                         onkeyup="PF('#{cc.clientId}_spatialUnitListTable').filter()"
                                                         placeholder="#{langBean.msg('table.research')}">

                                            </p:inputText>
                                </span>

                                <!-- Column toggler -->
                                <p:commandButton style="margin-left: 1em;" id="toggler" type="button" value="#{langBean.msg('table.columnvisibility')}" icon="pi pi-align-justify"/>
                                <p:columnToggler datasource=":#{cc.clientId}:spatialUnitListForm:spatialUnitDataTable"
                                                 trigger=":#{cc.clientId}:spatialUnitListForm:spatialUnitDataTable:toggler">
                                    <p:ajax event="toggle" listener="#{cc.attrs.panelModel.onToggle}"/>
                                </p:columnToggler>


                            </p:toolbarGroup>


                            <!--                                <p:toolbarGroup align="left">-->
                            <!--                                    <p:commandButton icon="bi bi-upload" disabled="true" styleClass="sia-icon-btn"/>-->
                            <!--                                    <p:commandButton icon="bi bi-download" disabled="true" styleClass="sia-icon-btn"/>-->
                            <!--                                </p:toolbarGroup>-->
                        </p:toolbarGroup>


                        <p:toolbarGroup align="right">
                            <p:commandButton value="#{langBean.msg('table.add')}" icon="bi bi-plus-square"
                                             oncomplete="scrollToPanel(#{flowBean.lastUpdatedPanelIndex});"
                                             disabled="#{cc.attrs.disableAddBtn}"
                                             action="#{flowBean.addNewSpatialUnitPanel(cc.attrs.panelModel)}"
                                             update="flow"
                                             style="margin-right: .5rem">
                            </p:commandButton>
                        </p:toolbarGroup>
                    </p:toolbar>

                </f:facet>

                <p:column responsivePriority="1" exportable="false" toggleable="false">
                    <p:toolbar>
                        <p:toolbarGroup>
                            <p:commandButton icon="bi bi-pin" disabled="true" styleClass="sia-icon-btn"/>
                        </p:toolbarGroup>
                    </p:toolbar>
                </p:column>


                <p:column toggleable="false" responsivePriority="1" headerText="#{langBean.msg('table.spatialunit.column.name')}" sortBy="#{item.name}" filterBy="#{item.name}">
                    <p:commandLink
                                   action="#{flowBean.goToSpatialUnitByIdNewPanel(item.id,cc.attrs.panelModel)}"
                                   oncomplete="scrollToPanel(#{flowBean.lastUpdatedPanelIndex});"
                                   update="flow"
                    >
                        <h:outputText value="#{item.name}"/>
                    </p:commandLink>


                </p:column>

                <!-- Spatial unit type column -->
                <p:column responsivePriority="1" headerText="#{langBean.msg('table.spatialunit.column.type')}"  sortBy="#{item.category.label}"
                          filterBy="#{item.category}"
                          filterMatchMode="exact">
                    <f:facet name="filter">
                        <p:selectCheckboxMenu
                                label="#{langBean.msg('table.spatialunit.column.type.filter')}"
                                value="#{cc.attrs.selectedCategories}"
                                filter="true"
                                filterMatchMode="contains"
                                onchange="PF('#{cc.clientId}_spatialUnitListTable').filter()"
                                converter="#{conceptLabelConverter}">
                            <f:selectItems value="#{cc.attrs.panelModel.categoriesAvailable()}"
                                           var="cat"
                                           itemValue="#{cat}"
                                           itemLabel="#{cat.value}"
                            />
                        </p:selectCheckboxMenu>
                    </f:facet>
                    <p:chip label="#{labelBean.findLabelOf(item.category)}" icon="pi pi-map-marker"
                            styleClass="mr-2 spatial-unit-type-chip"/>
                </p:column>

                <!-- Creation time -->
                <p:column responsivePriority="2" headerText="#{langBean.msg('table.spatialunit.column.creationdate')}" sortBy="#{item.creationTime}"
                >
                    <h:outputText value="#{panelModel.formatUtcDateTime(item.creationTime)}"/>
                </p:column>

                <!-- Auteur/Proprietaire -->
                <p:column responsivePriority="2" headerText="#{langBean.msg('table.spatialunit.column.author')}" sortBy="#{item.author}" filterMatchMode="exact" filterBy="#{item.author}"
                >
                    <f:facet name="filter">
                        <p:selectCheckboxMenu
                                label="#{langBean.msg('table.spatialunit.column.author.filter')}"
                                value="#{cc.attrs.panelModel.selectedAuthors}"
                                filter="true"
                                filterMatchMode="contains"
                                onchange="PF('#{cc.clientId}_spatialUnitListTable').filter()"
                                converter="#{personConverter}">
                            <f:selectItems value="#{cc.attrs.panelModel.authorsAvailable()}"
                                           var="person"
                                           itemValue="#{person}"
                                           itemLabel="#{person.displayName()}"
                            />
                        </p:selectCheckboxMenu>
                    </f:facet>
                    #{item.author.displayName()}
                </p:column>

                <!-- Parents -->
                <p:column responsivePriority="3">
                    <f:facet name="header">
                        <i class="bi bi-geo-alt"/>
                        <span>#{langBean.msg('table.spatialunit.column.parents')}</span>
                    </f:facet>
                    <ui:repeat value="#{item.parents}" var="parent" varStatus="status">
                        <p:commandLink rendered="#{status.index lt 3}" style="display: block; padding: 2px 0;"
                                       action="#{flowBean.goToSpatialUnitByIdCurrentPanel(parent.id, cc.attrs.panelModel)}"
                                       oncomplete="scrollToPanel(#{flowBean.lastUpdatedPanelIndex});"
                                       update="flow">
                            <h:outputText value="#{parent.name}"/>
                        </p:commandLink>
                    </ui:repeat>
                    <h:outputText rendered="#{fn:length(item.parents) gt 3}" value="+ #{fn:length(item.parents) - 3}"
                                  style="display: block; color: gray; margin-top: 2px;"/>
                </p:column>

                <!-- Children -->
                <p:column responsivePriority="3" >
                    <f:facet name="header">
                        <i class="bi bi-geo-alt"/>
                        <span>#{langBean.msg('table.spatialunit.column.children')}</span>
                    </f:facet>
                    <ui:repeat value="#{item.children}" var="child" varStatus="status">
                        <p:commandLink rendered="#{status.index lt 3}" style="display: block; padding: 2px 0;"
                                       action="#{flowBean.goToSpatialUnitByIdCurrentPanel(child.id, cc.attrs.panelModel)}"
                                       oncomplete="scrollToPanel(#{flowBean.lastUpdatedPanelIndex});"
                                       update="flow">
                            <h:outputText value="#{child.name}"/>
                        </p:commandLink>
                    </ui:repeat>
                    <h:outputText value="+ #{fn:length(item.children) - 3}"
                                  style="display: block; color: gray; margin-top: 2px;"
                                  rendered="#{fn:length(item.children) gt 3}"/>
                </p:column>

                <!-- Actions -->
                <p:column responsivePriority="3">
                    <f:facet name="header">
                        <i class="bi bi-arrow-down-square"/>
                        <span>#{langBean.msg('table.spatialunit.column.actions')}</span>
                    </f:facet>
                    <ui:repeat value="#{item.relatedActionUnitList}" var="action" varStatus="status">
                        <p:commandLink rendered="#{status.index lt 3}" style="display: block; padding: 2px 0;"
                                       >
                            <h:outputText value="#{action.name}"/>
                        </p:commandLink>
                    </ui:repeat>
                    <h:outputText value="+ #{fn:length(item.relatedActionUnitList) - 3}"
                                  style="display: block; color: gray; margin-top: 2px;"
                                  rendered="#{fn:length(item.relatedActionUnitList) gt 3}"/>
                </p:column>

                <!-- Enregistrements -->
                <p:column responsivePriority="3"  >
                    <f:facet name="header">
                        <i class="bi bi-pencil-square"/>
                        <span>#{langBean.msg('table.spatialunit.column.recordings')}</span>
                    </f:facet>
                    <ui:repeat value="#{item.recordingUnitList}" var="recording" varStatus="status">
                        <p:commandLink styleClass="sia-recording-unit-command-link" rendered="#{status.index lt 3}" style="display: block; padding: 2px 0;"
                                       >
                            <h:outputText value="#{recording.fullIdentifier}"/>
                        </p:commandLink>
                    </ui:repeat>
                    <h:outputText value="+ #{fn:length(item.recordingUnitList) - 3}"
                                  style="display: block; color: gray; margin-top: 2px;"
                                  rendered="#{fn:length(item.recordingUnitList) gt 3}"/>
                </p:column>

                <!-- Action toolbar-->
                <p:column responsivePriority="1" exportable="false" toggleable="false">
                    <p:toolbar>
                        <p:toolbarGroup>
                            <p:commandButton icon="bi bi-bookmark" disabled="true" styleClass="sia-icon-btn"/>
                            <p:commandButton icon="bi bi-pencil" disabled="true" styleClass="sia-icon-btn"/>
                            <p:commandButton icon="bi bi-copy" disabled="true" styleClass="sia-icon-btn"/>
                        </p:toolbarGroup>
                    </p:toolbar>
                </p:column>

            </p:dataTable>


        </h:form>
    </cc:implementation>
</ui:composition>

