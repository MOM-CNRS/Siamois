<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:cc="http://xmlns.jcp.org/jsf/composite"
                xmlns:cellbody="http://java.sun.com/jsf/composite/pages/shared/cellbody"
                xmlns:sharedInput="http://xmlns.jcp.org/jsf/composite/pages/shared/input"
                xmlns:cellheader="http://java.sun.com/jsf/composite/pages/shared/cellheader"
                xmlns:f="http://java.sun.com/jsf/core"
>
    <cc:interface>
        <!-- Attributes to pass the bean's list and optional additional parameters -->
        <cc:attribute name="lazyDataModel" required="true"
                      type="fr.siamois.ui.lazydatamodel.BaseRecordingUnitLazyDataModel"/>
        <cc:attribute name="panelModel" required="true" type="fr.siamois.ui.bean.panel.models.panel.AbstractPanel"/>
        <cc:attribute name="panelIndex" required="true" type="java.lang.Integer"/>
        <cc:attribute name="disableAddBtn" required="false" default="false" type="java.lang.Boolean"/>
        <cc:attribute name="displayColumnToggler" required="false" default="false" type="java.lang.Boolean"/>

    </cc:interface>
    <cc:implementation>


        <!-- datatable property partialUpdate=false because otherwise the paginator template is reset after sort or filter actions-->
        <p:dataTable paginator="true"
                     editable="true"
                     cellNavigation="true"
                     id="recordingUnitDataTable"
                     varStatus="status"
                     paginatorPosition="bottom" var="item"
                     selectionMode="multiple"
                     selection="#{cc.attrs.lazyDataModel.selectedUnits}"
                     widgetVar="#{cc.clientId}_recordingUnitListTable"
                     lazy="true"
                     globalFilter="#{cc.attrs.lazyDataModel.globalFilter}"
                     allowUnsorting="true"
                     sortBy="#{cc.attrs.lazyDataModel.sortBy}"
                     rows="#{cc.attrs.lazyDataModel.pageSizeState}"
                     first="#{cc.attrs.lazyDataModel.first}"
                     sortMode="multiple"
                     partialUpdate="false"
                     emptyMessage="#{langBean.msg('recordingUnitList.empty')}"
                     paginatorTemplate="Rows per page: {RowsPerPageDropdown} {RowReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                     rowsPerPageTemplate="5,10,15,20,25"
                     value="#{cc.attrs.lazyDataModel}" class="recording-unit-datatable">

            <p:ajax event="rowEdit" listener="#{cc.attrs.lazyDataModel.handleRowEdit}"/>
            <p:ajax event="rowEditCancel"/>
            <p:ajax event="rowSelect" listener="#{cc.attrs.lazyDataModel.handleRowSelect}" immediate="true" process=""
                    update=":#{cc.clientId}:recordingUnitDataTable:tableToolbar"/>
            <p:ajax event="rowUnselect" listener="#{cc.attrs.lazyDataModel.handleRowUnselect}" immediate="true"
                    update=":#{cc.clientId}:recordingUnitDataTable:tableToolbar"/>

            <f:facet name="{RowReport}">

                        <span class="ui-paginator-current">#{cc.attrs.lazyDataModel.getFirstIndexOnPage()}-#{cc.attrs.lazyDataModel.getLastIndexOnPage()}
                            of #{cc.attrs.lazyDataModel.rowCount}</span>
            </f:facet>

            <f:facet name="header">
                <p:toolbar id="tableToolbar">
                    <p:toolbarGroup>
                        <p:toolbarGroup align="left">
                            <div style="display:flex; flex-direction: column; gap:0.2em">
                                <div>
                                    <!-- Global search -->
                                    <span class="filter-container ui-input-icon-left">
                                            <i class="bi bi-search"/>

                                                        <p:inputText id="globalFilter"
                                                                     value="#{cc.attrs.lazyDataModel.globalFilter}"
                                                                     onkeyup="PF('#{cc.clientId}_recordingUnitListTable').filter()"
                                                                     placeholder="#{langBean.msg('common.action.search')}">


                                                        </p:inputText>
                                            </span>

                                    <!-- Column toggler -->
                                    <p:commandButton
                                            rendered="#{cc.attrs.displayColumnToggler}"
                                            style="margin-left: 1em;" id="toggler" type="button"
                                                     value="#{langBean.msg('table.columnvisibility')}"
                                                     icon="pi pi-align-justify"/>
                                    <p:columnToggler
                                            rendered="#{cc.attrs.displayColumnToggler}"
                                            datasource=":#{cc.clientId}:recordingUnitDataTable"
                                            trigger=":#{cc.clientId}:recordingUnitDataTable:toggler">
                                        <p:ajax event="toggle" listener="#{cc.attrs.panelModel.onToggle}"/>
                                    </p:columnToggler>
                                </div>
                                <p:outputPanel id="bulkEditPanel"
                                               rendered="#{cc.attrs.lazyDataModel.selectedUnits.size() >0 and flowBean.readWriteMode == 'WRITE'}"
                                               style="display:flex; flex-direction: row; gap:0.5em;">
                                    <span>Edition du type en lot (les autres colonnes viendront plus tard) :</span>
                                    <sharedInput:conceptAutocompleteFieldCode id="bulkTypeComponent"
                                                                              panelStyleClass="recording-unit-autocomplete"
                                                                              selectedConcept="#{cc.attrs.lazyDataModel.bulkEditTypeValue}"
                                                                              field="#{cc.attrs.lazyDataModel.typeField}"
                                                                              editConceptUrl="#{spatialUnitFieldBean.getUrlForFieldCode('SIARU.TYPE')}"/>
                                    <p:commandButton value="Enregistrer"
                                                     update=":#{cc.clientId}:recordingUnitDataTable"
                                                     action="#{cc.attrs.lazyDataModel.saveFieldBulk()}"
                                    />
                                </p:outputPanel>

                            </div>


                        </p:toolbarGroup>


                    </p:toolbarGroup>


                    <p:toolbarGroup align="right">
                        <cc:renderFacet name="rightToolbar"/>
                    </p:toolbarGroup>
                </p:toolbar>

            </f:facet>


            <p:column toggleable="false"
                      headerText="#{langBean.msg('table.recordingunit.column.identifier')}"
                      sortable="true"
                      filterValue="#{cc.attrs.lazyDataModel.nameFilter}"
                      filterable="true"
                      field="full_identifier"
                      id="identifierCol">

                <p:commandLink
                        action="#{flowBean.goToRecordingUnitByIdNewPanel(item.id,cc.attrs.panelIndex)}"
                        onstart="PF('buiContent').show()"
                        oncomplete="PF('buiContent').hide();handleScrollToTop();"
                        process="@form"
                        update="flow"
                >
                    <h:outputText value="#{item.displayFullIdentifier()}"/>
                </p:commandLink>
            </p:column>


            <!-- type column -->
            <p:column headerText="#{langBean.msg('table.spatialunit.column.type')}"
                      sortable="true"
                      filterable="true"
                      field="category"
                      id="categoryCol"
                      filterMatchMode="exact">
                <f:facet name="filter">

                    <p:selectCheckboxMenu

                            label="#{langBean.msg('table.spatialunit.column.type.filter')}"
                            filter="true"
                            value="#{cc.attrs.lazyDataModel.selectedTypes}"
                            updateLabel="true"
                            filterMatchMode="contains"
                            onchange="PF('#{cc.clientId}_recordingUnitListTable').filter()"
                            converter="#{conceptLabelConverter}">

                        <f:selectItems
                                var="cat"
                                itemValue="#{cat}"
                                itemLabel="#{cat.value}"
                        />
                    </p:selectCheckboxMenu>

                </f:facet>
                <p:cellEditor>
                    <f:facet name="output">
                        <p:chip label="#{labelBean.findLabelOf(item.type)}"
                                styleClass="mr-2 recording-unit-type-chip">
                        </p:chip>
                    </f:facet>
                    <f:facet name="input">
                        <sharedInput:conceptAutocompleteFieldCode id="typeComponent"
                                                                  panelStyleClass="recording-unit-autocomplete"
                                                                  selectedConcept="#{item.type}"
                                                                  field="#{cc.attrs.lazyDataModel.typeField}"
                                                                  editConceptUrl="#{spatialUnitFieldBean.getUrlForFieldCode('SIARU.TYPE')}"/>
                    </f:facet>
                </p:cellEditor>

            </p:column>

            <!-- sous type -->
            <p:column responsivePriority="2" headerText="#{langBean.msg('recordingunit.field.secondaryType')}">
                        <p:chip label="#{labelBean.findLabelOf(item.secondaryType)}"
                                styleClass="mr-2 recording-unit-type-chip"/>

            </p:column>

            <!-- third type -->
            <p:column responsivePriority="2" headerText="#{langBean.msg('recordingunit.field.thirdType')}">
                <p:chip label="#{labelBean.findLabelOf(item.thirdType)}"
                        styleClass="mr-2 recording-unit-type-chip"/>

            </p:column>

            <!-- Creation time -->
            <p:column responsivePriority="4" headerText="#{langBean.msg('table.spatialunit.column.creationdate')}"
                      sortable="true"
                      filterable="false"
                      field="creationTime"
                      id="creationTimeCol"
            >
                <h:outputText value="#{panelModel.formatUtcDateTime(item.creationTime)}"/>
            </p:column>

            <!-- Crée par -->
            <p:column responsivePriority="4" headerText="#{langBean.msg('common.field.createdBy')}"
                      sortable="false"
                      filterable="false"
                      field="author"
                      id="authorCol"
                      filterMatchMode="exact"
            >
                <f:facet name="filter">
                    <p:selectCheckboxMenu
                            label="#{langBean.msg('table.spatialunit.column.author.filter')}"
                            filter="true"
                            updateLabel="true"
                            value="#{cc.attrs.lazyDataModel.selectedAuthors}"
                            filterMatchMode="contains"
                            onchange="PF('#{cc.clientId}_recordingUnitListTable').filter()"
                            converter="#{personConverter}">
                        <f:selectItems
                                var="person"
                                itemValue="#{person}"
                                itemLabel="#{person.displayName()}"
                        />
                    </p:selectCheckboxMenu>
                </f:facet>
                #{item.author.displayName()}
            </p:column>

            <!-- Redacteurs -->
            <p:column responsivePriority="2" headerText="#{langBean.msg('common.field.authors')}"
            >
                <cellbody:cellBodyMultiplePersons persons="#{item.authors}"/>
            </p:column>


            <!-- Fouilleurs -->
            <p:column responsivePriority="2" headerText="#{langBean.msg('common.field.excavators')}"
            >
                <cellbody:cellBodyMultiplePersons persons="#{item.excavators}"/>
            </p:column>

            <!-- parents -->
            <p:column responsivePriority="6">
                <f:facet name="header">
                    <cellheader:withIcon icon="bi bi-pencil-square"
                                         text="#{langBean.msg('table.spatialunit.column.parents')}"/>
                </f:facet>
                <cellbody:cellBodyThreeItems set="#{item.parents}" displayAttribute="fullIdentifier" />
            </p:column>


            <!-- Children -->
            <p:column responsivePriority="6">
                <f:facet name="header">
                    <cellheader:withIcon icon="bi bi-pencil-square"
                                         text="#{langBean.msg('table.spatialunit.column.children')}"/>
                </f:facet>
                <cellbody:cellBodyThreeItems set="#{item.children}" displayAttribute="fullIdentifier"/>
            </p:column>

            <!-- Action parent -->
            <p:column responsivePriority="6" headerText="#{langBean.msg('recordingunit.field.actionUnit')}">
                <h:outputLink value="#{request.contextPath}/action-unit/#{item.actionUnit.id}">
                    #{item.actionUnit.name}
                </h:outputLink>
            </p:column>

            <!-- Spatial parent -->
            <p:column responsivePriority="6" headerText="#{langBean.msg('recordingunit.field.spatialUnit')}">
                <h:outputLink value="#{request.contextPath}/spatial-unit/#{item.spatialUnit.id}">
                    #{item.spatialUnit.name}
                </h:outputLink>
            </p:column>


            <!-- Prelevements -->
            <p:column responsivePriority="3">
                <f:facet name="header">
                    <cellheader:withIcon icon="bi bi-box-2"
                                         text="#{langBean.msg('common.entity.specimen')}"/>
                </f:facet>
                <cellbody:cellBodyThreeItems
                        set="#{item.specimenList}"
                        panelModel="#{cc.attrs.panelModel}"
                        displayAttribute="fullIdentifier"
                        commandLinkStyleClass="sia-recording-unit-command-link"
                        onClickMethod="#{flowBean.goToSpecimenByIdNewPanel}"
                />
                <p:commandButton value="#{langBean.msg('common.action.create')}" icon="bi bi-plus-square"
                                 actionListener="#{genericNewUnitDialogBean.selectKind('SPECIMEN',item.specimenList, item)}"
                                 oncomplete="PF('newUnitDiag').show();"
                                 rendered="#{specimenBean.showCreateSpecimenButton(item)}"
                                 update="newUnitForm"
                                 style="margin-right: .5rem">
                </p:commandButton>
            </p:column>


            <!-- Action toolbar-->
            <p:column  exportable="false" toggleable="false">
                <p:toolbar id="actionToolbar">
                    <p:toolbarGroup>
                        <p:commandButton id="bookmarkToggleButton" icon="#{navBean.isRecordingUnitBookmarkedByUser(item.fullIdentifier) ?
                            'bi bi-bookmark-x-fill' : 'bi bi-bookmark-plus' }" styleClass="sia-icon-btn"
                                         action="#{navBean.toggleRecordingUnitBookmark(item)}"
                                         update="bookmarkToggleButton navBarCsrfForm:siamoisNavForm:bookmarkGroup"/>
                        <p:commandButton rendered="#{flowBean.readWriteMode == 'WRITE'}" icon="bi bi-copy"
                                         action="#{cc.attrs.lazyDataModel.duplicateRow()}"
                                         update=":#{cc.clientId}:recordingUnitDataTable"
                                         styleClass="sia-icon-btn"/>
                    </p:toolbarGroup>
                </p:toolbar>
            </p:column>

            <!-- Edit toolbar -->
            <p:column  rendered="#{flowBean.readWriteMode == 'WRITE'}" exportable="false"
                      toggleable="false">
                <p:rowEditor editTitle="Edit Row" cancelTitle="Cancel Edit" saveTitle="Save Row"/>
            </p:column>

        </p:dataTable>

        <p:blockUI block="recordingUnitDataTable" trigger="recordingUnitDataTable"
                   widgetVar="#{cc.clientId}_buiRecordingUnitDatatable">
            <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
        </p:blockUI>


    </cc:implementation>
</ui:composition>

