<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:form="http://java.sun.com/jsf/composite/pages/shared/form">

    <ui:define name="head">

        <script>


            function handleScrollToTop() {

                const container = document.getElementById("content");
                if (container) {
                    container.firstElementChild.scrollIntoView({behavior: 'smooth', block: 'start'});
                }

            }

            function setFormHasBeenModified(element) {
                // Mark the form as modified and activate buttons
                console.log(element)

                element = (typeof element.closest === 'function') ? element : document.getElementById(element.id);

                let inputEl;
                // If not input, find first input to add border
                if (element.tagName !== 'INPUT') {
                    inputEl = element.querySelector('input');

                } else {
                    inputEl = element;
                }

                if (inputEl) {
                    $(inputEl).addClass('sia-modified-field');
                }

                const form = element.closest('form');
                const parent = form.parentElement;
                const hiddenField = form.querySelector('input[id$="spatialUnitForm:hasUnsavedModifications"]')
                if (hiddenField) {
                    hiddenField.value = 'true';
                    form.classList.add('form-modified'); // Feedback visuel optionnel
                }

                // if(parent) {
                //     const saveAsDraftButton = parent.querySelector('button[id$="spatialUnitForm:saveButton"], input[id$="spatialUnitForm:saveButton"]');
                //     const saveAndValidateButton = parent.querySelector('button[id$="spatialUnitForm:saveAndValidateButton"], input[id$="spatialUnitForm:saveAndValidateButton"]');
                //     const cancelModificationsButton = parent.querySelector('[id$="spatialUnitForm\\:cancelButton"]');
                //
                //     // Activate buttons
                //     if (saveAsDraftButton) {
                //         $(saveAsDraftButton).removeAttr("disabled");
                //         $(saveAsDraftButton).removeClass('ui-state-disabled');
                //     }
                //     if (saveAndValidateButton) {
                //         $(saveAndValidateButton).removeAttr("disabled");
                //         $(saveAndValidateButton).removeClass('ui-state-disabled');
                //     }
                //     if (cancelModificationsButton) {
                //         $(cancelModificationsButton).removeClass('ui-state-disabled');
                //     }
                //
                // }


            }
        </script>


    </ui:define>

    <ui:define name="metadata">
        <f:event type="preRenderView" listener="#{presentationBean.continueIfLogged()}"/>
    </ui:define>

    <ui:define name="content">

        <div style="display: flex; flex-direction: row; flex-shrink: 0">
            <div id="search-bar" class="hide-small-screen" style="flex:8">
                <form:csrfform formId="searchBarForm" id="searchBarCsrfForm">
                    <article>
                        <h:panelGroup styleClass="ui-inputgroup">
                            <h:panelGroup id="iconInstit" styleClass="ui-inputgroup-addon">
                                <i class="bi bi-buildings"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                    id="selectOneMenuInstitution"
                                    value="#{flowBean.selectedInstitution}"
                                    filter="true"
                                    converter="#{institutionConverter}"
                                    filterMatchMode="startsWith"
                                    filterNormalize="true"
                                    var="inst"
                            >
                                <f:selectItems value="#{flowBean.institutions}"
                                               var="item"
                                               itemValue="#{item}"
                                               itemLabel="#{item.name}"
                                />

                                <p:column>
                                    <h:outputText value="#{inst.name}"/>
                                </p:column>

                                <p:ajax event="change"
                                        process="@this"
                                        listener="#{flowBean.onInstitutionChange}"
                                        />

                            </p:selectOneMenu>

                        </h:panelGroup>
                        <h:panelGroup styleClass="ui-inputgroup">
                            <h:panelGroup id="iconSU" styleClass="ui-inputgroup-addon">
                                <i class="bi bi-geo-alt"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                    id="selectOneMenuIconSU"
                                    value="#{flowBean.FSelectedSpatialUnit}"
                                    filter="true"
                                    filterMatchMode="startsWith"
                                    filterNormalize="true"
                                    var="su"
                            >
                                <f:selectItems value="#{flowBean.FSpatialUnits}"
                                               var="item"
                                               itemValue="#{item}"
                                               itemLabel="#{item.name}"
                                               itemDisabled="true"
                                />

                                <p:column>
                                    <f:facet name="header">
                                        <h:outputText value="ID"/>
                                    </f:facet>
                                    <h:outputText value="#{su.id}"/>
                                </p:column>

                                <p:column>
                                    <f:facet name="header">
                                        <h:outputText value="Name"/>
                                    </f:facet>
                                    <h:outputText value="#{su.name}"/>
                                </p:column>

                            </p:selectOneMenu>
                        </h:panelGroup>
                        <h:panelGroup styleClass="ui-inputgroup">
                            <h:panelGroup id="iconAU" styleClass="ui-inputgroup-addon">
                                <i class="bi bi-arrow-down-right-square"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                    id="selectOneMenuIconAU"
                                    value="#{flowBean.FSelectedActionUnit}"
                                    filter="true"
                                    filterMatchMode="startsWitch"
                                    filterNormalize="true"
                                    var="au"
                            >
                                <f:selectItems value="#{flowBean.FActionUnits}"
                                               var="item"
                                               itemValue="#{item}"
                                               itemLabel="#{item.name}"
                                />

                                <p:column>
                                    <f:facet name="header">
                                        <h:outputText value="ID"/>
                                    </f:facet>
                                    <h:outputText value="#{au.id}"/>
                                </p:column>

                                <p:column>
                                    <f:facet name="header">
                                        <h:outputText value="Name"/>
                                    </f:facet>
                                    <h:outputText value="#{au.name}"/>
                                </p:column>

                            </p:selectOneMenu>
                        </h:panelGroup>
                        <p:button value="+" disabled="true"/>
                    </article>
                    <article>
                    <span class="ui-input-icon-right">
                        <p:inputText styleClass="searchInput" placeholder="" value="ðŸš§" disabled="true"/>
                        <i class="bi bi-play-circle"/>
                    </span>
                    </article>
                </form:csrfform>
            </div>
            <div id="smallScreenToolbar" class="show-small-screen" style="align-content: center; flex:1;
            text-align:left; background: var(--siamois-green-light-100);padding: 0.5em">
                <form:csrfform formId="toggleButtonSidebarPanelForm" id="toggleButtonSidebarPanelCsrfForm">
                    <div style="display:flex;gap:1em;">
                        <p:commandButton  icon="bi bi-list" onclick="toggleSiamoisSidebar()">

                        </p:commandButton>
                        <h:panelGroup styleClass="ui-inputgroup">
                            <h:panelGroup id="iconInstitSmallScreen" styleClass="ui-inputgroup-addon">
                                <i class="bi bi-buildings"/>
                            </h:panelGroup>
                            <p:selectOneMenu
                                    id="selectOneMenuInstitutionSmallScreen"
                                    value="#{flowBean.selectedInstitution}"
                                    filter="true"
                                    style="max-width: 10em; text-overflow: ellipsis"
                                    converter="#{institutionConverter}"
                                    filterMatchMode="startsWith"
                                    filterNormalize="true"
                                    var="inst"
                            >
                                <f:selectItems value="#{flowBean.institutions}"
                                               var="item"
                                               itemValue="#{item}"
                                               itemLabel="#{item.name}"
                                />

                                <p:column>
                                    <h:outputText value="#{inst.name}"/>
                                </p:column>

                                <p:ajax event="change"
                                        process="@this"
                                        listener="#{flowBean.onInstitutionChange}"
                                />
                            </p:selectOneMenu>
                        </h:panelGroup>
                    </div>

                </form:csrfform>
            </div>
            <div id="read-write-switch" style="align-content: center; flex:1;
            text-align:right; background: var(--siamois-green-light-100);padding: 0.5em; gap:0.5em; display: flex; flex-direction: row-reverse;">
                <h:form id="readWriteSwitchForm">
                    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                    <p:selectBooleanButton id="readWriteSwitchButton" value="#{flowBean.isWriteMode}" offIcon="bi bi-eyeglasses" onIcon="bi bi-pen">
                        <p:ajax event="valueChange" listener="#{flowBean.changeReadWriteMode()}" update="flow readWriteSwitchForm"
                                onstart="PF('buiContent').show()" oncomplete="PF('buiContent').hide()"/>
                    </p:selectBooleanButton>
                    <p:tooltip for="readWriteSwitchButton" value="#{flowBean.readWriteSwitchTooltip}" position="bottom"/>
                </h:form>
                <h:form id="fieldDesktopSwitchForm">
                    <input type="hidden"  name="${_csrf.parameterName}" value="${_csrf.token}"/>
                    <p:selectBooleanButton style="display:none;" value="#{flowBean.isFieldMode}" offIcon="bi bi-pc-display" onIcon="bi bi-phone" id="fieldOfficeSwitchButton">
                        <p:ajax event="valueChange" listener="#{flowBean.changeFieldOfficeMode()}" update="flow fieldDesktopSwitchForm"
                                onstart="PF('buiContent').show()" oncomplete="PF('buiContent').hide()"/>
                    </p:selectBooleanButton>
                    <p:tooltip for="fieldOfficeSwitchButton" value="#{flowBean.fieldOfficeSwitchTooltip}" position="bottom"/>
                </h:form>
                <ui:include src="/dialog/unsavedUpdates/unsavedUpdatesDialog.xhtml"/>
            </div>
        </div>


        <p:outputPanel id="flow" style="
        flex: 1;
             overflow-y: auto;">



            <h:panelGroup
                    style="#{flowBean.fullscreenPanelIndex == -1 ? 'display:flex;flex-direction: column;gap:3em;padding:1em;' : 'display:flex;flex-direction: column;gap:1em;padding:0.5em;'}"
                    id="flow-panels">
                <c:forEach items="#{flowBean.panels}" var="panel" varStatus="status">
                    <p:panel styleClass="#{panel.panelClass}"
                             rendered="#{flowBean.fullscreenPanelIndex ==-1 || flowBean.fullscreenPanelIndex == status.index}"
                             id="panel-${status.index}"
                             toggleable="true" closable="true"
                             toggleableHeader="true" collapsed="#{panel.collapsed}">

                        <p:ajax event="close" listener="#{flowBean.closePanelAtIndex(status.index)}" update="flow"
                                onstart="PF('buiContent').show()" oncomplete="PF('buiContent').hide()"/>
                        <p:ajax event="toggle" listener="#{flowBean.handleToggleOfPanelAtIndex(status.index)}"/>

                        <f:facet name="header">
                            <p:outputPanel id="panel-${status.index}-header" style="display: flex;gap: 0.5em; align-items: center;
                            flex-wrap: wrap; float:left;color: var(--main-color);">
                                <ui:include rendered="#{panel.displayHeader() != null}"
                                            src="#{panel.displayHeader()}">
                                    <ui:param name="panelModel" value="#{panel}"/>
                                 </ui:include>
                            </p:outputPanel>
                        </f:facet>
                        <ui:include src="#{panel.display()}" id="panel-body">
                            <ui:param name="panelModel" value="#{panel}"/>
                            <ui:param name="panelIndex" value="#{status.index}"/>
                        </ui:include>
                        <f:facet name="actions">
                            <form:csrfform formId="actionsFormId">
                                <p:commandLink id="refreshPanelButton"
                                               styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default"
                                               action="#{panel.refresh()}"
                                               onstart="PF('buiPanel_${status.index}').show();"
                                               oncomplete="PF('buiPanel_${status.index}').hide();"
                                               onclick="event.stopPropagation();"
                                               update="panel-${status.index}">
                                    <h:outputText styleClass="bi bi-arrow-clockwise"/>
                                </p:commandLink>
                                <p:commandLink id="bookmarkToggleButton"
                                               styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default"
                                               action="#{navBean.togglePanelBookmark(panel)}"
                                               onclick="event.stopPropagation();"
                                               update="bookmarkToggleButton navBarCsrfForm:siamoisNavForm">
                                    <h:outputText styleClass="#{navBean.isPanelBookmarkedByUser(panel) ?
                            'ui-icon bi bi-bookmark-fill' : 'ui-icon bi bi-bookmark'}"/>
                                </p:commandLink>
                                <p:commandLink rendered="#{flowBean.fullscreenPanelIndex ==-1}"
                                               action="#{flowBean.fullScreen(panel)}"
                                               update="flow"
                                               styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default">
                                    <h:outputText styleClass="ui-icon bi bi-arrows-angle-expand"/>
                                </p:commandLink>
                                <p:commandLink rendered="#{flowBean.fullscreenPanelIndex == status.index}"
                                               action="#{flowBean.closeFullScreen()}"
                                               update="flow"
                                               styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default">
                                    <h:outputText styleClass="ui-icon bi bi-arrows-angle-contract"/>
                                </p:commandLink>
                            </form:csrfform>
                        </f:facet>
                    </p:panel>
                    <p:blockUI block="panel-${status.index}" widgetVar="buiPanel_${status.index}">
                        <i class="pi pi-spin pi-spinner" style="font-size: 3rem"/>
                    </p:blockUI>

                </c:forEach>
            </h:panelGroup>


        </p:outputPanel>
        <p:blockUI block="flow" widgetVar="buiContent">
            <i class="pi pi-spin pi-spinner" style="font-size: 3rem"/>
        </p:blockUI>

        <ui:include src="/dialog/document/newDocument.xhtml"/>
        <ui:include src="/dialog/newunit/newUnitDialog.xhtml"/>
        <ui:include src="/dialog/unsavedUpdates/unsavedUpdatesOnInstitutionChangeDialog.xhtml"/>

    </ui:define>


</ui:composition>